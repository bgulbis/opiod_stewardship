---
title: "Sickle Cell Patients"
author: "Brian Gulbis, PharmD, BCPS"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
    html_document:
        code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
options(
    knitr.table.format = "html",
    knitr.kable.NA = ""
)
```

```{r}
library(tidyverse)
library(kableExtra)

dir_data <- "../data/tidy/sickle_cell"
tz_locale <- locale(tz = "US/Central")

get_data <- function(path, pattern) {
    f <- list.files(path, pattern, full.names = TRUE)
    
    n <- f %>% 
        purrr::map_int(~ nrow(data.table::fread(.x, select = 1L))) 

    f[n > 0] %>%
    purrr::map_df(
        readr::read_csv,
        locale = tz_locale
    ) %>%
    rename_all(stringr::str_to_lower)
}

data_pts <- get_data(dir_data, "patients") 
data_meds <- get_data(dir_data, "narcotics")
data_pca <- get_data(dir_data, "pca")

```

```{r}
data_pts %>%
    summarize_at(
        c("age", "los"),
        funs(
            mean,
            sd, 
            median,
            q25 = quantile(., 0.25), 
            q75 = quantile(., 0.75)
        ),
        na.rm = TRUE
    ) %>%
    gather(key, value) %>%
    separate(key, c("var", "measure"), sep = "_") %>%
    spread(measure, value) %>%
    select(
        var,
        mean,
        sd,
        median,
        q25,
        q75
    ) %>%
    mutate_at(
        "var", 
        str_replace_all,
        pattern = c(
            "age" = "Age (years)",
            "los" = "Length of stay (days)"
        )
    ) %>%
    knitr::kable(
        caption = "Demographics of sickle cell patients",
        digits = 1,
        col.names = c(
            "Variable",
            "Mean",
            "Std Dev",
            "Median",
            "25th",
            "75th"
        )
    ) %>%
    kable_styling()
```

```{r}
df <- data_pts %>%
    mutate_at(
        c("race", "sex", "dispo_dc", "med_service_dc", "encounter_type"), 
        funs(coalesce(., "Unknown"))
    ) %>%
    mutate(
        dispo_group = case_when(
            str_detect(dispo_dc, "Hospice|Deceased") ~ "Deceased / Hospice",
            str_detect(dispo_dc, "Home|Left|Elopement") ~ "Home",
            str_detect(dispo_dc, "DC/|Acute|Skilled|Intermediate") ~ "Transfered"
        ),
        reason_admit = if_else(priority == 1, "Yes", "No")
    )

df_sex <- count(df, sex)
df_race <- count(df, race)
df_dispo <- count(df, dispo_group)
df_medsvc <- count(df, med_service_dc)
df_encntr <- count(df, encounter_type)
df_primary <- count(df, reason_admit)

n_sex <- nrow(df_sex)
n_race <- nrow(df_race)
n_dispo <- nrow(df_dispo)
n_medsvc <- nrow(df_medsvc)
n_encntr <- nrow(df_encntr)
n_primary <- nrow(df_primary)

df %>%
    add_count(encounter_type) %>%
    unite(encounter_type, encounter_type, n) %>%
    add_count(sex) %>%
    unite(sex, sex, n) %>%
    add_count(race) %>%
    unite(race, race, n) %>%
    add_count(dispo_group) %>%
    unite(dispo_group, dispo_group, n) %>%
    add_count(med_service_dc) %>%
    unite(med_service_dc, med_service_dc, n) %>%
    add_count(reason_admit) %>%
    unite(reason_admit, reason_admit, n) %>%
    select(
        encounter_type,
        sex,
        race,
        dispo_group,
        med_service_dc,
        reason_admit
    ) %>%
    gather(measure, value) %>%
    distinct() %>%
    separate(value, c("var", "value"), sep = "_") %>%
    mutate_at("value", as.numeric) %>%
    mutate(pct = value / nrow(data_pts) * 100) %>%
    arrange(measure, desc(value)) %>%
    select(-measure) %>%
    knitr::kable(
        format = "html",
        digits = 0,
        # caption = "Demographics of sickle cell patients",
        col.names = c(
            "Measure",
            "N",
            "(%)"
        )
    ) %>%
    kable_styling(full_width = TRUE) %>%
    group_rows(
        group_label = "Disposition", 
        start_row = 1, 
        end_row = n_dispo
    ) %>%
    group_rows(
        group_label = "Encounter Type", 
        start_row = 1 + n_dispo, 
        end_row = n_dispo + n_encntr
    ) %>%
    group_rows(
        group_label = "Discharge Service", 
        start_row = 1 + n_dispo + n_encntr, 
        end_row = n_dispo + n_encntr + n_medsvc
    ) %>%
    group_rows(
        group_label = "Race", 
        start_row = 1 + n_dispo + n_medsvc + n_encntr, 
        end_row = n_dispo + n_encntr + n_medsvc + n_race
    ) %>%
    group_rows(
        group_label = "Primary ICD Code", 
        start_row = 1 + n_dispo + n_encntr + n_medsvc + n_race, 
        end_row = n_dispo + n_encntr + n_medsvc + n_race + n_primary
    ) %>%
    group_rows(
        group_label = "Sex", 
        start_row = 1 + n_dispo + n_encntr + n_medsvc + n_race + n_primary, 
        end_row = n_dispo + n_encntr + n_medsvc + n_race + n_primary + n_sex
    ) 

```

```{r, eval=FALSE}
df_pca <- data_pca %>%
    mutate(pca = TRUE) %>%
    distinct(encounter_id, pca)

df_meds <- data_meds %>%
    mutate(med = TRUE) %>%
    distinct(encounter_id, med)

x <- data_pts %>%
    left_join(df_meds, by = "encounter_id") %>%
    left_join(df_pca, by = "encounter_id")

y <- anti_join(data_pca, data_pts, by = "encounter_id") %>%
    distinct(encounter_id)
```

